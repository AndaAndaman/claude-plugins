---
name: evolve
description: Cluster related instincts into full Claude skills
allowed-tools:
  - Read
  - Write
  - Glob
  - Grep
  - AskUserQuestion
  - Task(skill-builder)
---

# Evolve Command

Find related instincts that form a coherent skill, generate a combined markdown document, and feed it through the /convert-to-skill pipeline via the skill-builder agent.

## Execution Workflow

### Step 0: Load Configuration

Read the plugin's `config/defaults.json` for threshold values. Then check `.claude/md-to-skill.local.md` for user overrides.

Key config values:
- `evolution.minClusterSize` (default: 3) — minimum instincts per cluster
- `evolution.minAverageConfidence` (default: 0.5) — minimum average confidence

### Step 1: Load All Instincts

Use Glob to find all instinct files:
```
.claude/md-to-skill-instincts/*.md
```

For each file, parse YAML frontmatter to extract:
- `id`, `trigger`, `confidence`, `domain`, `observations`, `evolved`, `source`, `auto_approved`

**Skip instincts with `evolved: true`** — they've already been converted.
**Skip inherited instincts** (`source: "inherited"`) — only personal instincts evolve.

If fewer than `evolution.minClusterSize` non-evolved personal instincts exist:
```
Not enough instincts to form clusters yet.
You have {count} instincts. Clusters need at least 3 related instincts.

Keep working and run /observe to grow your instinct collection.
```
Exit.

### Step 2: Cluster by Domain

Group instincts by their `domain` tag:
- Collect all instincts sharing the same domain
- Calculate cluster metrics:
  - Count of instincts
  - Average confidence
  - Total observations across instincts

### Step 3: Filter Viable Clusters

A cluster is viable when:
- **`evolution.minClusterSize`+ instincts** in the group (default: 3)
- **Average confidence >= `evolution.minAverageConfidence`** (default: 0.5)

**Priority:**
1. Clusters containing auto-approved instincts are prioritized first
2. When multiple clusters are viable, prioritize those with higher average session diversity (instincts observed across 3+ sessions indicate more consistent patterns)
3. Note in presentation: "Priority: Clusters with instincts observed across 3+ sessions"

To calculate session diversity for a cluster: average the `sessions` array length across all instincts in the cluster (treat missing `sessions` as length 1).

Discard clusters that don't meet both criteria.

If no viable clusters:
```
No clusters ready to evolve yet.

Current clusters:
- {domain}: {count} instincts, avg confidence {avg}
  {Reason not viable: "needs X more instincts" or "average confidence too low (need 0.5)"}

Run /observe after more sessions to strengthen instincts.
```
Exit.

### Step 4: Present Clusters to User

Show viable clusters:

```
Found {count} cluster(s) ready to evolve:

1. "{domain}" ({instinct_count} instincts, avg confidence {avg})
   - {id} ({confidence})
   - {id} ({confidence})
   - {id} ({confidence})
   → Would create skill: "{domain}-preferences"

2. "{domain}" ({instinct_count} instincts, avg confidence {avg})
   - {id} ({confidence})
   - {id} ({confidence})
   - {id} ({confidence})
   → Would create skill: "{domain}-patterns"
```

Use AskUserQuestion:
```json
{
  "questions": [{
    "question": "Which clusters should be evolved into skills?",
    "header": "Evolve",
    "multiSelect": true,
    "options": [
      {
        "label": "Cluster 1: {domain}",
        "description": "{count} instincts, avg confidence {avg}"
      },
      {
        "label": "Cluster 2: {domain}",
        "description": "{count} instincts, avg confidence {avg}"
      },
      {
        "label": "All clusters",
        "description": "Evolve all viable clusters"
      }
    ]
  }]
}
```

### Step 5: Generate Markdown for Selected Clusters

For each selected cluster, generate a combined markdown document:

```markdown
# {Domain Title} Patterns

Learned patterns from session observations covering {domain} behaviors.

## Overview

This skill captures {count} observed patterns related to {domain}, validated through
{total_observations} observations across multiple sessions.

## Patterns

### {Instinct 1 Title}

**When:** {trigger}
**Action:** {action from instinct body}
**Confidence:** {confidence} ({observations} observations)

### {Instinct 2 Title}

**When:** {trigger}
**Action:** {action from instinct body}
**Confidence:** {confidence} ({observations} observations)

...

## Evidence

### {Instinct 1 ID}
{Evidence section from instinct file}

### {Instinct 2 ID}
{Evidence section from instinct file}

---
*Generated by /evolve from {count} instincts on {date}*
*Source: session-observation instincts*
```

Write this markdown to a temp location: `.claude/md-to-skill-evolve-{domain}.md`

### Step 6: Launch Skill Builder

For each generated markdown file, launch the skill-builder agent:

Task(skill-builder)

Provide the generated markdown file path as the source file for conversion.

The skill-builder will handle:
- Parsing the content
- Naming the skill
- Organizing into skill structure
- Quality validation

### Step 7: Mark Instincts as Evolved

After successful skill creation, update each instinct file in the cluster:
- Add `evolved: true` to the YAML frontmatter
- Add `evolved_to: "{skill-name}"` to frontmatter
- Add `evolved_date: "{ISO timestamp}"` to frontmatter

### Step 8: Clean Up and Report

Delete the temporary markdown files created in Step 5.

Show results:
```
## Evolution Complete

**Clusters evolved:** {count}

1. {domain} → skill "{skill-name}"
   - {count} instincts merged
   - Instincts marked as evolved

Next steps:
- Test the new skill by asking questions matching its trigger phrases
- Run /instinct-status to see updated instinct states
- Run /skill-health to monitor the new skill's usage
```

## Error Handling

**Skill builder fails:** Report which cluster failed, keep instincts unmarked (not evolved).

**Partial success:** Report successes and failures separately, only mark successful clusters.

**User cancels:** Exit without changes.
